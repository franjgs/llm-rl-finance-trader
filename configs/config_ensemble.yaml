# ===================================================================
# ENSEMBLE CONFIGURATION (Statistical + ML, non-RL)
# Used for backtesting and signal generation.
# Updated: November 17, 2025 (XGBoost Enabled)
# ===================================================================

# ===================================================================
# GENERAL SETTINGS
# ===================================================================
verbose: 1                                   # 0 = silent, 1 = normal, 2 = debug
stock_symbol: "NVDA"
# stock_symbol: "TSLA"
# stock_symbol: "AAPL"
# stock_symbol: "META"
# stock_symbol: "SPY"

data_interval: "1h"                          # Data frequency: "1d", "1h", "30m", "15m", "5m", "1m"
start_date: "2023-12-01"
end_date: "2025-11-15"

initial_balance: 1000000                     # Starting capital for backtest
commission_bps: 1.5                          # Commission in basis points (e.g., 1.5bps = 0.00015)
slippage_bps: 2.0                            # Slippage in basis points

# ===================================================================
# PATHS (Matching RL structure)
# ===================================================================
paths:
  raw_dir: "data/raw"
  processed_dir: "data/processed"
  cache_dir: "data/cache"
  models_dir: "models"
  results_dir: "results"

# ===================================================================
# SENTIMENT SETTINGS
# ===================================================================
sentiment:
  enabled: true
  mode: "combined"                           # "combined" or "individual" sources
  sources:
    - finnhub
    - alphavantage
    - newsapi
    - yahoo
    - googlenews
    - gdelt
  model: "mrm8488/distilroberta-finetuned-financial-news-sentiment-analysis" # The Hugging Face model to use
  force_refresh: false                       # Re-download and process sentiment data

# ---------------------------------------------------------------
# GLOBAL POSITION SCALING
# ---------------------------------------------------------------
position_scaling: 1.0

# ===================================================================
# ENSEMBLE MODELS
# ===================================================================
ensemble:
  max_exposure_abs: 1.0                      # Maximum absolute exposure (1.0 = 100% of capital)
    # ---------------------------------------------------------------
    # MOMENTUM FACTOR – DISABLED
    # ---------------------------------------------------------------
  momentum:
    enabled: true                           # Kept disabled as it introduced noise/bias
    lookback_bars: 48
    vol_lookback_bars: 96
    use_log_returns: true
    target_vol: 0.20
    max_exposure: 1.0
    smoothing_alpha: 0.10
    min_abs_mom: 0.0
    fillna_method: ffill
    return_raw: true

  # ---------------------------------------------------------------
  # VOLATILITY TARGETING
  # ---------------------------------------------------------------
  volatility_targeting:
      enabled: true                          # Controls position sizing based on realized volatility
      target_vol: 0.20                       # Target annual volatility
      max_leverage: 2.0
      vol_lookback_bars: 60
      min_vol: 1e-4
      max_scale: 2.0
      return_raw: false

  # ---------------------------------------------------------------
  # XGBOOST MODEL - NOW ENABLED AS SENTIMENT FILTER
  # ---------------------------------------------------------------
  xgboost:
    enabled: true                            # Set to TRUE to enable training and signal generation
    model_path: "models/xgb_ensemble.joblib"
    retrain: true                            # MUST BE TRUE for the initial training run.

    prediction_horizon_hours: 8              # Target: Price move in the next 8 hours

    # Feature engineering parameters
    n_lags: 5
    use_rolling_features: true
    dropna: true

    # Time-series Cross-Validation settings
    cv_splits: 3
    test_size_ratio: 0.2

    # XGBoost Hyperparameters
    params:
      n_estimators: 300
      max_depth: 4
      learning_rate: 0.05
      subsample: 0.8
      colsample_bytree: 0.8
      min_child_weight: 3
      objective: "binary:logistic"
      eval_metric: "logloss"
      reg_lambda: 1.0
      reg_alpha: 0.0

    early_stopping_rounds: 30
    eval_set_fraction: 0.1

    threshold: 0.5
    output_type: "class"  # Output 1 or 0 (Buy/No Buy)
    # output_type: "proba"

  # ---------------------------------------------------------------
  # LSTM MODEL (Disabled for now)
  # ---------------------------------------------------------------
  lstm:
      enabled: true                 # <── ACTIVADO
      model_path: "models/lstm_ensemble.pth"
      retrain: true                 # Primera vez sí, luego puedes poner false
      sequence_length: 60
      input_size: 16                # número aproximado de features que genera generate_features()
      hidden_size: 64
      num_layers: 2
      dropout: 0.2
      epochs: 20
      batch_size: 32
      learning_rate: 0.001
      prediction_horizon_hours: 8
      normalize: true
      output_type: "class"          # <── IGUAL QUE XGBOOST → 0 o 1 (funciona perfecto así)
      threshold: 0.5

  # ---------------------------------------------------------------
  # SENTIMENT SIGNAL (Core signal generator)
  # ---------------------------------------------------------------
  sentiment_signal:
    enabled: true
    pos_threshold: 0.05
    neg_threshold: -0.3
    smoothing_window: 1
    output_type: "raw"                       # Outputs a value between 0.0 and 1.0 based on sentiment
    scale_min: -1.0
    scale_max: 1.0
    normalize: false
    signal_scaling: 1.0                      # Initial signal scaling factor

  # ---------------------------------------------------------------
  # RL-STYLE RISK OVERLAY (Drawdown Control)
  # ---------------------------------------------------------------
  rl_risk_overlay:
    enabled: true
    
    # NEW PARAMETER: Annualization factor for 1h data (approx. trading hours in a year)
    periods_per_year: 2016 

    # Drawdown-based reduction (INCREASED TOLERANCE)
    drawdown_reduce_level: -0.15             # Start reducing exposure if Drawdown hits 15%
    drawdown_flat_level: -0.25               # Shut down completely if Drawdown hits 25%

    # Sharpe-based boost 
    sharpe_boost_threshold: 0.7              # Boost exposure if Sharpe is above this threshold
    sharpe_lookback_days: 30                 

    # Scaling adjustments
    max_boost: 1.5                           # Maximum multiplier when performance is good
    reduce_factor: 0.35                      # Rate of reduction when Drawdown levels are breached

    store_multiplier: true                   # Store the calculated risk multiplier in the results

  # ---------------------------------------------------------------
  # WEIGHTING LOGIC
  # ---------------------------------------------------------------
  weighting:
    equal_risk: true                         # Use equal risk weighting across all enabled models
    min_position_threshold: 0.0              # Minimum required signal/position magnitude to open a trade

# ===================================================================
# LOGGING
# ===================================================================
logging:
  level: "INFO"
  show_progress_bars: true
  debug_features: false